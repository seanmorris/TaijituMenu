!function(){var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}}(name,prop[name]):prop[name]}function Class(){if(!initializing&&this.init)this.init.apply(this,arguments)}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class}}();function ClickVector(mouseState,deadZone){this.startX=mouseState[0];this.endX=mouseState[0];this.startY=mouseState[1];this.endY=mouseState[1];window.mouseX=mouseState[0];window.mouseY=mouseState[1];this.deadZone=deadZone||20;this.age=0;this.x=0;this.y=0;this.magnitude=null;this.theta=null;this.RIGHT=0;this.DOWN=1;this.LEFT=2;this.UP=3;this.EAST=this.RIGHT;this.SOUTH=this.DOWN;this.WEST=this.LEFT;this.NORTH=this.UP;this.size=60;this.inidcatorSize=this.size;this.margin=this.inidcatorSize*1.6;this.alpha=.4;this.released=false;this.undragged=true;this.release=function(){this.released=true};this.active=function(){return!this.released&&this.magnitude>this.deadZone};this.cardinal=function(){if(Math.abs(this.y)>Math.abs(this.x)&&this.y>0){return this.UP}if(Math.abs(this.y)<Math.abs(this.x)&&this.x<0){return this.RIGHT}if(Math.abs(this.y)>Math.abs(this.x)&&this.y<0){return this.DOWN}if(Math.abs(this.y)<Math.abs(this.x)&&this.x>0){return this.LEFT}return 0};this.update=function(newMouseState){this.endX=window.mouseX;this.endY=window.mouseY;this.x=this.startX-this.endX;this.y=this.startY-this.endY;this.magnitude=Math.sqrt(this.x*this.x+this.y*this.y);if(this.magnitude>this.deadZone){this.undragged=false}this.theta=this.x?Math.atan(this.y/this.x):1.5*Math.PI;if(this.x>0){this.theta+=Math.PI}this.age++};this.render=function(context){context.lineWidth=3;context.globalAlpha=this.alpha;context.beginPath();context.strokeStyle="#FFF";context.arc(this.startX-$(context.canvas).offset().left,this.startY-$(context.canvas).offset().top,this.size,0,2*Math.PI);context.fillStyle="#CA0";if(!this.active()){context.fillStyle="#C55";context.fill()}else{context.beginPath();this.renderQuads(context)}context.globalAlpha=1;context.strokeStyle="#333";context.beginPath();context.arc(this.startX-$(context.canvas).offset().left,this.startY-$(context.canvas).offset().top,this.deadZone,0,2*Math.PI);context.stroke()};this.renderQuads=function(context){for(var i in[0,1,2,3]){context.beginPath();context.moveTo(this.startX-$(context.canvas).offset().left,this.startY-$(context.canvas).offset().top);context.arc(this.startX-$(context.canvas).offset().left,this.startY-$(context.canvas).offset().top,i==this.cardinal()?this.inidcatorSize:this.deadZone,(i?i*.5-.25:.25)*Math.PI,(i?i*.5+.25:.75)*Math.PI);context.lineTo(this.startX-$(context.canvas).offset().left,this.startY-$(context.canvas).offset().top);if(i==this.cardinal()){context.fillStyle="#C55"}else{context.fillStyle="#CA0"}context.fill()}}}var Input=Class.extend({init:function(){this.lastKeyStates=[];this.keyStates=[];this.lastMouseStates=[];this.mouseStates=[];this.clickVectors=[];this.scrollStates=[];this.preventScroll=false;var _this=this;$(document).keydown(function(e){if(_this.keyStates[e.keyCode||e.which]){}else{_this.keyStates[e.keyCode||e.which]=1}});$(document).keyup(function(e){_this.keyStates[e.keyCode||e.which]=0});$(document).bind("contextmenu",function(e){e.preventDefault()});$(document).mousedown(function(e){if(_this.mouseStates[e.button]&&_this.mouseStates[e.button].length==3&&_this.mouseStates[e.button][2]){}else{console.log(e.button+" mouse button down.");_this.mouseStates[e.button]=[e.pageX,e.pageY,1]}});$(document).bind("touchstart",function(e){var touches=e.originalEvent.changedTouches;var i=0;while(i<touches.length){var ii=i;if(i==1){ii=2}else if(i==2){ii=1}if(_this.mouseStates[ii]&&_this.mouseStates[ii].length==3&&_this.mouseStates[ii][2]){}else{_this.mouseStates[ii]=[touches[ii].pageX,touches[ii].pageY,1]}i++}});$(document).mouseup(function(e){console.log(e.button+" mouse button up.");_this.mouseStates[e.button]=[e.pageX,e.pageY,0]});window.mouseX=0;window.mouseY=0;$(document).bind("touchmove",function(e){var touches=e.originalEvent.changedTouches;var i=0;while(i<touches.length){var ii=i;if(i==1){ii=2}window.mouseX=touches[ii].pageX;window.mouseY=touches[ii].pageY;i++}});$(document).mousemove(function(e){window.mouseX=e.pageX;window.mouseY=e.pageY});$(document).bind("touchend",function(e){var touches=e.originalEvent.changedTouches;var i=0;while(i<touches.length){var ii=i;if(i==1){ii=2}else if(i==2){ii=1}_this.mouseStates[ii]=[touches[ii].pageX,touches[ii].pageY,0];i++}});$(document).bind("mousewheel DOMMouseScroll",function(e){if(e.originalEvent.wheelDelta/120>0){console.log("scrollUp at ("+window.mouseX+", "+window.mouseY+")");_this.scrollStates[1]=2}else{console.log("scrollDown at ("+window.mouseX+", "+window.mouseY+")");_this.scrollStates[0]=2}if(_this.preventScroll){e.preventDefault()}})},update:function(){for(var i in this.keyStates){if(this.keyStates[i]===0&&this.keyStates[i]===this.lastKeyStates[i]){delete this.keyStates[i];delete this.lastKeyStates[i]}else if(i in this.keyStates){this.lastKeyStates[i]=this.keyStates[i]}if(i in this.keyStates&&this.keyStates[i]){this.keyStates[i]++}}for(var i in this.mouseStates){if(this.mouseStates[i]&&this.lastMouseStates[i]&&this.mouseStates[i].length==3&&this.lastMouseStates[i].length==3&&this.mouseStates[i][2]===0&&this.mouseStates[i][2]===this.lastMouseStates[i][2]){delete this.mouseStates[i];delete this.lastMouseStates[i]}else if(this.mouseStates[i]&&this.mouseStates[i].length==3){this.lastMouseStates[i]=this.mouseStates[i]}if(this.mouseStates[i]&&this.mouseStates[i].length==3&&this.mouseStates[i][2]){this.mouseStates[i][2]++}if(this.clickVectors[i]&&this.clickVectors[i].released){delete this.clickVectors[i]}if(this.mouseStates[i]&&this.mouseStates[i][2]){if(this.clickVectors[i]){this.clickVectors[i].update(this.mouseStates[i])}else{this.clickVectors[i]=new ClickVector(this.mouseStates[i])}}else if(this.clickVectors[i]){this.clickVectors[i].release()}}for(var i in this.scrollStates){if(this.scrollStates[i]){this.scrollStates[i]--}if(this.scrollStates[i]===0){delete this.scrollStates[i]}}}});function Menu(canvas,input){this.cacheBg=null;this.ignoreInput=0;this.ignoreInputTime=5;this.maxMag=250;this.options={};this.selected=0;this.selectedOption;this.textColor="#A65560";this.boxColor="#280212";this.selectedTextColor="#F8435C";this.selectedBoxColor="#652931";this.leftMargin=-180;this.leftTextMargin=10;this.topMargin=150;this.boxSpacing=10;this.mainBoxExtraSpacing=10;this.boxSize=50;this.mainBoxExtraSize=10;this.textMargin=35;this.context=canvas[0].getContext("2d");this.jqdoc=$(document);this.lastMouseX=0;this.lastMouseY=0;this.age=0;this.update=function(){if(this.ignoreInput<0){this.ignoreInput=0}this.age++;if(window.mouseX!=this.lastMouseX||window.mouseY!=this.lastMouseY){console.log(window.mouseX,this.lastMouseX);this.mouseSelect=[window.mouseX-this.jqdoc.scrollLeft(),window.mouseY-this.jqdoc.scrollTop()]}if(!this.ignoreInput||input.scrollStates[0]||input.scrollStates[1]||input.clickVectors[0]&&input.clickVectors[0].undragged){if(this.used){this.used();this.used=null}var tickDelay=0;if(input.clickVectors&&input.clickVectors[0]&&input.clickVectors[0].magnitude){var mag=input.clickVectors[0].magnitude;if(mag>this.maxMag){mag=this.maxMag}tickDelay=this.maxMag/20-mag/20}if(input.keyStates[38]||input.keyStates[87]||input.scrollStates[1]||input.clickVectors[0]&&input.clickVectors[0].active()&&input.clickVectors[0].cardinal()==input.clickVectors[0].UP){this.selected--;this.mouseSelect=[0,0];this.ignoreInput=this.ignoreInputTime+tickDelay}else if(input.keyStates[40]||input.keyStates[83]||input.scrollStates[0]||input.clickVectors[0]&&input.clickVectors[0].active()&&input.clickVectors[0].cardinal()==input.clickVectors[0].DOWN){this.selected++;this.mouseSelect=[0,0];this.ignoreInput=this.ignoreInputTime+tickDelay}else if(input.keyStates[32]===0||input.keyStates[13]===0||input.clickVectors[0]&&input.clickVectors[0].undragged&&input.clickVectors[0].released&&input.clickVectors[0].age<this.age){console.log(input.mouseStates[0][2],this.age);this.select(this.mouseSelected||this.selected)}var opLen=0;for(var i in this.options){opLen++}if(this.selected<0){this.selected=opLen-1}else if(this.selected>=opLen){this.selected=0}}else{this.ignoreInput--}this.lastMouseX=window.mouseX;this.lastMouseY=window.mouseY};this.flushBg=function(){this.cacheBg=null};this.render=function(noBg){var width=canvas.width();var height=canvas.height();var center=[width/2,height/2];this.context.textAlign="left";this.context.font="18pt monospace";var j=0;for(var i in this.options){offset=(this.boxSpacing+this.boxSize)*(j-this.selected+1);var textOffset=0;var boxOffset=0;if(j==this.selected){this.context.fillStyle=this.selectedBoxColor;this.context.fillRect(center[0]-(this.mainBoxExtraSize+this.boxSize)+this.leftMargin,offset+this.topMargin,this.mainBoxExtraSize+this.boxSize,this.mainBoxExtraSize+this.boxSize);this.context.fillStyle=this.selectedTextColor;this.context.fillText(i,center[0]+this.leftTextMargin+this.leftMargin,offset+this.topMargin+this.textMargin+this.mainBoxExtraSpacing)}else{if(j>this.selected){boxOffset=this.boxSpacing*2;textOffset=this.textMargin+this.mainBoxExtraSpacing}else{boxOffset=this.boxSpacing*-1;textOffset=this.textMargin}this.context.fillStyle=this.boxColor;if(this.leftMargin+width/2-this.boxSize<this.mouseSelect[0]){if(offset+this.topMargin+boxOffset<this.mouseSelect[1]){if(offset+this.topMargin+boxOffset+this.boxSize>this.mouseSelect[1]){this.context.fillStyle=this.selectedBoxColor}}}this.context.fillRect(center[0]-this.boxSize+this.leftMargin,offset+this.topMargin+boxOffset,this.boxSize,this.boxSize);this.context.fillStyle=this.textColor;if(this.leftMargin+width/2-this.boxSize<this.mouseSelect[0]){if(offset+this.topMargin+boxOffset<this.mouseSelect[1]){if(offset+this.topMargin+boxOffset+this.boxSize>this.mouseSelect[1]){this.context.fillStyle=this.selectedTextColor}}}this.context.fillText(i,center[0]+this.leftTextMargin+this.leftMargin,offset+this.topMargin+textOffset)}j++}};this.used=null;this.select=function(option){var width=canvas.width();for(var i in this.options){if(!option--){this.used=this.options[i]}}var j=0;for(var i in this.options){offset=(this.boxSpacing+this.boxSize)*(j-this.selected+1);if(j>this.selected){boxOffset=this.boxSpacing*2}else{boxOffset=this.boxSpacing*-1}if(this.leftMargin+width/2-this.boxSize<this.mouseSelect[0]){if(offset+this.topMargin+boxOffset<this.mouseSelect[1]){if(offset+this.topMargin+boxOffset+this.boxSize>this.mouseSelect[1]){this.used=this.options[i];this.mouseSelected=j}}}j++}}}var Taijitu=Class.extend({init:function(position,size,rotation,alpha){this.position=position;this.size=size;this.rotation=rotation;this.alpha=alpha},update:function(position,size,rotation,alpha){this.position=position;this.size=size;this.rotation=rotation;this.alpha=alpha},render:function(context){var origAlpha=context.globalAlpha;context.globalAlpha=this.alpha;context.globalCompositeOperation="source-over";context.beginPath();context.fillStyle="#000";context.arc(this.position[0]-Math.sin(this.rotation)*this.size/2,this.position[1]-Math.cos(this.rotation)*this.size/2,this.size/2,Math.PI*1.5-this.rotation,Math.PI*2.5-this.rotation,true);context.arc(this.position[0]+Math.sin(this.rotation)*this.size/2,this.position[1]+Math.cos(this.rotation)*this.size/2,this.size/2,Math.PI*1.5-this.rotation,Math.PI*2.5-this.rotation);context.arc(this.position[0],this.position[1],this.size,Math.PI*.5-this.rotation,Math.PI*1.5-this.rotation,true);context.closePath();context.fill();context.beginPath();context.fillStyle="#FFF";context.arc(this.position[0]+Math.sin(this.rotation)*this.size/2,this.position[1]+Math.cos(this.rotation)*this.size/2,this.size/2,Math.PI*1.5-this.rotation,Math.PI*2.5-this.rotation);context.arc(this.position[0]-Math.sin(this.rotation)*this.size/2,this.position[1]-Math.cos(this.rotation)*this.size/2,this.size/2,Math.PI*1.5-this.rotation,Math.PI*2.5-this.rotation,true);context.arc(this.position[0],this.position[1],this.size,Math.PI*.5-this.rotation,Math.PI*1.5-this.rotation);context.closePath();context.fill();context.globalCompositeOperation="destination-out";context.fillStyle="#000";context.beginPath();context.arc(this.position[0]+Math.sin(this.rotation)*this.size/2,this.position[1]+Math.cos(this.rotation)*this.size/2,this.size/8,0,Math.PI*2);context.closePath();context.fill();context.fillStyle="#FFF";context.beginPath();context.arc(this.position[0]-Math.sin(this.rotation)*this.size/2,this.position[1]-Math.cos(this.rotation)*this.size/2,this.size/8,0,Math.PI*2);context.closePath();context.fill();context.globalCompositeOperation="source-over";context.fillStyle="#000";context.beginPath();context.arc(this.position[0]+Math.sin(this.rotation)*this.size/2,this.position[1]+Math.cos(this.rotation)*this.size/2,this.size/8,0,Math.PI*2);context.closePath();context.fill();context.fillStyle="#FFF";context.beginPath();context.arc(this.position[0]-Math.sin(this.rotation)*this.size/2,this.position[1]-Math.cos(this.rotation)*this.size/2,this.size/8,0,Math.PI*2);context.closePath();context.fill();context.globalAlpha=origAlpha}});var TaijituMenu=Class.extend({init:function(canvasSelector,options){this.canvas=$(canvasSelector);this.context=this.canvas[0].getContext("2d");this.options=[];this.states={CLOSED:1,OPEN:2};this.t=new Taijitu([0,0],1,Math.PI/2);this.state=this.states.CLOSED;this.input=new Input;this.menu=new Menu(this.canvas,this.input);this.menu.options=options;var _this=this;setInterval(function(){_this.canvas[0].setAttribute("width",$("html").width());_this.canvas[0].setAttribute("height",$("html").height());_this.update()},50)},update:function(){this.context.clearRect(0,0,this.canvas.width(),this.canvas.height());this.context.fillStyle="#000";this.context.fillRect(0,0,this.canvas.width(),this.canvas.height());this.t.update([this.canvas.width()/2,this.canvas.height()/2],this.canvas.height()*.75,0,.02);this.t.render(this.context);this.input.update();var triggered=false;if(this.input.mouseStates[2]&&this.input.mouseStates[2][2]===0){this.menu.age=0;triggered=true}if(this.input.mouseStates[0]&&this.input.mouseStates[0][2]===30&&this.input.clickVectors[0].undragged){this.menu.age=0;triggered=true}if(triggered&&this.state!==this.states.OPEN){this.open()}else if(triggered){this.close()}if(this.state==this.states.OPEN){this.menu.update();this.menu.render()}},open:function(){console.log("Open menu");this.menu.selected=0;$("#TaijituMenuLayer").show();this.state=this.states.OPEN;this.input.preventScroll=true;this.age=1},close:function(){console.log("Close menu");$("#TaijituMenuLayer").hide();this.state=this.states.CLOSED;this.input.preventScroll=false}});